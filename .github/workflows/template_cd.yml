name: template cd

on:
  workflow_call:
    inputs:
      runs-on:
        description: Platform to execute on
        type: string
        default: windows-latest
      env:
        description: Environment deploy to
        type: string
        default: DEV
      DATABRICKS_NOTEBOOK_PATH:
        description: Location where notebooks will be deployed in Databricks
        type: string
        default: /Shared/notebook-tests/dbxbuild_${{github.run_number}}/    
      kvname:
        description: keyvault name
        type: string
        default: kvabdev

jobs:
  deploy:
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.env }}

    steps:
    - uses: Azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - uses: Azure/get-keyvault-secrets@v1
      with: 
        keyvault: "${{ inputs.kvname }}"
        secrets: 'FuncAppName, IntPublishProfile'
      id: kvSecret
    - name: Download Artifacts
      uses: actions/download-artifact@v3
      with:
        name: FunctionZip
        path: ./artifacts
    - name: Run a one-line script
      run: ls -l ./artifacts
    - name: Azure Functions Action
      uses: Azure/functions-action@v1.4.6
      with:
        app-name: ${{ steps.kvSecret.outputs..FuncAppName }}
        package: ./artifacts/FunctionApp1.zip
        publish-profile: ${{ steps.kvSecret.outputs..IntPublishProfile }}